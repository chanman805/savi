
<!doctype html>
<html>
<head>
 <link href="https://fonts.googleapis.com/css2?family=Courier+Prime&display=swap" rel="stylesheet">
  <style>
  * {
    margin: 0;
    padding: 0;
  }
  body {
    margin: 0;
    padding: 0;
	font-family: 'Courier Prime';
  }
  .blipchart {
    background: Transparent;
    display: block;
  }
  .legend {
    text-align: right;
    padding-right: 2em;
    padding-top: 1em;
    padding-bottom: 1em;
    font-family:'Courier Prime';
  }
  .legend span {
    padding-left: 2em;
  }
  .dnslegend form {
    display: inline;
  }
  .dnslegend form label {
    margin: -2em;
    padding: 2em;
    font-weight: bold;
  }
  .dnslegend form label:hover {
    background: #ff8;
  }
  canvas {
  position:absolute;
  top:0%;
  left:0%;
  width:100%;
  height:100px;
  }
  </style>
</head>
<body>

<canvas style = "display:none"class='blipchart' id='hires'></canvas>
<canvas class='blipchart' id='lores'></canvas>
<canvas style = "display:none"class='blipchart' id='vlores'></canvas>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js'></script>
<script>
'use strict';
var running = true;
var wantDns = false;
var dnsName;
var now;
if (window.performance && window.performance.now) {
  now = function() { return window.performance.now(); };
} else {
  now = function() { return new Date().getTime(); };
}

var getValues = function(obj) {
  var out = [];
  for (var i in obj) {
    out.push(obj[i]);
  }
  return out;
};

var nextFrame =
    window.requestAnimationFrame ||
    window.webkitRequestAnimationFrame ||
    window.mozRequestAnimationFrame ||
    function(callback) {
      setTimeout(callback, 1);
    };
var range = 2200;
var log_range = Math.log(range * 1.5);
var default_delay = 1000;
var absolute_mindelay = 10;
var mindelay = default_delay;
var lastBotch = 0;

var updateMinDelay = function() {
  $.getJSON('https://gfblip.appspot.com/mindelay?callback=?', function(data) {
    var newdelay = parseInt(data);
    if (newdelay >= absolute_mindelay) {
      mindelay = newdelay;
    } else {
      mindelay = default_delay;
    }

    setTimeout(updateMinDelay, 1);
  });
};
updateMinDelay();

var BlipCanvas = function(canvas, width) {
  this.canvas = canvas;
  this.canvas.width = 1000;
  this.canvas.height = 1000;
  this.ctx = this.canvas.getContext('2d');
  this.xofs = 100;
  this.current_x = 0;
  this.xdiv = width / 1000;

  this.drawYAxis = function() {
    var labels = [2, 5, 10, 20, 50, 100, 200, 500, 1000, 2000];
    this.ctx.fillStyle = 'white';
    this.ctx.textBaseline = 'middle';
    this.ctx.textAlign = 'right';
    this.ctx.font = '15px Courier Prime';
    for (var i = 0; i < labels.length; i++) {
      var msecs = labels[i];
      this.ctx.fillText(msecs, (this.xofs - 10), this.msecToY(msecs));
    }
    this.ctx.scale(1, 2);
    this.ctx.textAlign = 'center';
    this.ctx.rotate(-Math.PI / 2);
    this.ctx.font = '0px Courier Prime';
    this.ctx.fillText('', -this.canvas.height / 2 / 2, 16);
    this.ctx.rotate(Math.PI / 2);
    this.ctx.scale(1, 1 / 2);
  };

  this.nextX = function(msecs) {
    var steps = msecs / absolute_mindelay;
    if (steps > 100) {
      steps = 100;
    }
    var x_inc = steps / this.xdiv;
    var new_x = (this.current_x + x_inc) % (this.canvas.width - this.xofs);

    // draw the new bar
    this.ctx.fillStyle = 'rgba(26,26,26,1)';
    this.ctx.fillRect(new_x + this.xofs + 1, 0,
                      4, this.canvas.height);

    // wipe out the old bar
    this.ctx.fillStyle = 'rgba(26,26,26,1)';
    this.ctx.fillRect(this.current_x + this.xofs, 0,
                      x_inc + 1, this.canvas.height);
    if (new_x < this.current_x) {
      this.ctx.fillRect(this.xofs, 0,
                        new_x - 1, this.canvas.height);
    }
    this.current_x = new_x;
  };

  this.msecToY = function(msecs) {
    return this.canvas.height -
        (Math.log(msecs) * this.canvas.height / log_range);
  };

  this.drawBlip = function(color, startTime, endTime, minlatency, width) {
    var msecs = endTime - startTime;
    if (msecs < minlatency) {
  
      lastBotch = endTime;
    }
    if (endTime > 2100 && endTime - lastBotch < 2100) {
     
      msecs = range;
    }
    var y = this.msecToY(msecs);
    var x = this.current_x + this.xofs;
    this.ctx.fillStyle = color;
    this.ctx.fillRect(x - 55, y , 5, 25);
    if (msecs >= range) {
      this.ctx.fillStyle = '#f00';
      this.ctx.fillRect(x+1000, y, 5, 25);
    }
  };
};

var c1 = new BlipCanvas($('#hires')[0], 1000);
var c2 = new BlipCanvas($('#lores')[0], 10000);
var c3 = new BlipCanvas($('#vlores')[0], 100000);

var blips = [];

var addBlip = function(color, url, minlatency) {
  blips.push({color: color, url: url, minlatency: minlatency});
};

var gotBlip = function(color, url, minlatency, startTime) {
  var endTime = now();
  c1.drawBlip(color, startTime, endTime, minlatency, url ? 1 : 3);
  c2.drawBlip(color, startTime, endTime, minlatency, url ? 1 : 3);
  c3.drawBlip(color, startTime, endTime, minlatency, url ? 1 : 3);
  addBlip(color, url, minlatency);
};

var startBlips = function() {
  while (blips.length) {
    var blip = blips.shift();
    if (!blip.url && !wantDns) {
      var createResult = function(blip) {
        return function() {
          addBlip(blip.color, blip.url, blip.minlatency);
        }
      };
      var result = createResult(blip);
      setTimeout(result, 1);
    } else {
      var createResult = function(blip) {
        var startTime = now();
        var result = function() {
          gotBlip(blip.color, blip.url, blip.minlatency, startTime);
        };
        return result;
      };
      var result = createResult(blip);
      var url = blip.url;
      if (!blip.url) {
  
        var g = dnsName.match(/(^[^\/]*\/\/)([^:\/]*)(.*)/);
        url = (g[1] + Math.random() +
               'random.' + g[2] + '.blipdns.apenwarr.ca' + g[3]);
      }
      $.ajax({
        'url': url,
        crossDomain: false,
        timeout: range
      }).complete(result);
    }
  }
};

var lastTick = now(), lastStart = lastTick;
var gotTick = function() {
  var t = now();
  var tdiff = t - lastTick;
  if (running) {
    if (tdiff >= absolute_mindelay) {
      if (t - lastStart > mindelay) {
        lastStart = t;
        startBlips();
      }
      c1.nextX(tdiff);
      c2.nextX(tdiff);
      c3.nextX(tdiff);
      lastTick = t;
    }
    nextFrame(gotTick);
  }
};

var toggleBlip = function() {
  if (running) {
    running = 0;
  } else {
    running = 1;
    lastTick = now();
    nextFrame(gotTick);
  }
};

var toggleDns = function() {
  wantDns = dnsName && !wantDns;
};

c1.drawYAxis();
var addGstatic = function() {
  addBlip('rgba(0,255,0,0.8)', 'http://gstatic.com/generate_204', 0);
};
addBlip('rgba(0,0,0,1.0)', null, 5);


$.ajax({
  'url': 'https://mlab-ns.appspot.com/ndt?policy=all',
  crossDomain: true,
}).success(function(ndt) {
 
  var hosts = [];
  for (var i in ndt) {
    hosts.push([ndt[i].country, ndt[i].city, ndt[i].url]);
  }
  hosts.sort();
  var one_per_country = {};
  for (var i in hosts) {
    var country = hosts[i][0];
    var city = hosts[i][1];
    var url = hosts[i][2];
    if (!one_per_country[country]) {
      one_per_country[country] = {
        where: city + ', ' + country,
        url: url,
        rttList: []
      };
    }
  }

  var roundsDone = 0;
  var outstanding = 0;
  var doRound = function() {
    for (var ci in one_per_country) {
      (function() {
        var v = one_per_country[ci];
        var startTime = now();
        outstanding++;
        $.ajax({
          'url': v.url,
          crossDomain: false,
          timeout: range
        }).complete(function() {
          v.rttList.push(now() - startTime);
          outstanding--;
          console.log('outstanding', outstanding);
          if (!outstanding) {
            roundsDone++;
            if (roundsDone < 3) {
              doRound();
            } else {
              console.log(one_per_country);
              var results = getValues(one_per_country);
              results.sort(function(a, b) {
                return (Math.min.apply(Math, a.rttList) -
                        Math.min.apply(Math, b.rttList));
              });
              console.log(results);
              // Pick an entry at least one city away
              var best = results[1];
              dnsName = best.url;
              $('#internetlegend').text('o ' + best.where);
              addBlip('rgba(0,0,255,0)', best.url, 5);
            }
          }
        });
      })();
    }
  };
  doRound();
});


var tryFastSites = [
  '192.168.0.1',
  '192.168.0.254',
  '192.168.1.1',
  '192.168.1.254',
  '192.168.2.1',
  '192.168.2.254',
  '192.168.3.1',
  '192.168.3.254',
  '192.168.4.1',
  '192.168.4.254',
  '10.0.0.1',
  '10.0.0.254',
  '10.1.1.1',
  '10.1.1.254',
  '10.33.4.1',
  '10.33.4.254'
];
var curFastSite = 0;
var fastest;

function doneFastSite(reason, host, url, start_time) {
  var delay = now() - start_time;
  console.debug(reason + ' delay=' + delay + ' ' + url);
  if (reason != 'timeout' && (!fastest || delay < fastest[0])) {
    fastest = [delay, host, url];
  }
  curFastSite++;
  if (curFastSite < tryFastSites.length) {
    nextFastSite();
  } else {
    if (fastest) {
      $('#locallegend').html('o ' + fastest[1]);
      addBlip('rgba(0,192,0,0.8)', fastest[2], 0);
    } else {
      $('#locallegend').html('o gstatic.com');
      addGstatic();
    }
  }
}

function nextFastSite() {
  var host = tryFastSites[curFastSite];
  var url = 'http://' + host + ':8999/generate_204';
  var start_time = now();
  $.ajax({
    'url': url,
    crossDomain: false,
    timeout: 1
  }).complete(function(e, reason) {
    doneFastSite(reason, host, url, start_time);
  });
}
nextFastSite();

nextFrame(gotTick);


</script>
<script>

var fixSize = function() {
  var hmain = window.innerHeight - $('.legend')[0].clientHeight;
  var h1 = Math.round(hmain * 0.05);
  $('#hires').width(window.innerWidth).height(hmain - 3 * h1);
  $('#lores').width(window.innerWidth).height(h1 * 2);
  $('#vlores').width(window.innerWidth).height(h1);
}

$(window).resize(fixSize).ready(fixSize);
$('.blipchart').click(toggleBlip);
$('#wantdns').change(toggleDns);

</script>


</body>
</html>
